<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Swile Export - Installation du bookmarklet</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        line-height: 1.6;
        color: #333;
      }
      h1 {
        color: #1a1a2e;
      }
      .bookmarklet {
        display: inline-block;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 16px;
        margin: 20px 0;
        cursor: grab;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      .bookmarklet:hover {
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
      }
      .step {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }
      .step-number {
        display: inline-block;
        width: 28px;
        height: 28px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 28px;
        margin-right: 10px;
        font-weight: bold;
      }
      code {
        background: #e8e8e8;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 14px;
      }
      .warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 12px;
        margin: 15px 0;
      }
    </style>
  </head>
  <body>
    <h1>Swile Export</h1>
    <p>Exporte tes operations Swile en un clic.</p>

    <h2>Installation</h2>
    <p>Glisse ce bouton dans ta barre de favoris :</p>

    <a
      class="bookmarklet"
      href='javascript:(async function swileExport(){&#x27;use strict&#x27;;const CONFIG={OPERATIONS_URL:&#x27;https://neobank-api.swile.co/api/v3/user/operations&#x27;,WALLETS_URL:&#x27;https://employee-bff-api.swile.co/api/wallets/get-wallets&#x27;,API_KEY:&#x27;393e1b0abfebf6da88aa57cfa1a126f97bf0b818&#x27;,ITEMS_PER_PAGE:100,MAX_PAGES:50,};function getJWT(){const match=document.cookie.match(/lunchr:jwt=([^;]+)/);return match?match[1]:null;}function buildHeaders(jwt,extra={}){return {Authorization:`Bearer ${jwt}`,&#x27;X-API-Key&#x27;:CONFIG.API_KEY,&#x27;X-Lunchr-Platform&#x27;:&#x27;web&#x27;,&#x27;Content-Type&#x27;:&#x27;application/json&#x27;,...extra,};}async function fetchWallets(jwt){const response=await fetch(CONFIG.WALLETS_URL,{headers:buildHeaders(jwt,{&#x27;X-API-Version&#x27;:&#x27;0&#x27;}),});if (!response.ok){throw new Error(`Wallets error:${response.status}${response.statusText}`);}return response.json();}async function fetchAllOperations(jwt,onProgress=()=&gt;{}){const allItems=[];let cursor=new Date().toISOString();let page=0;let hasMore=true;while (hasMore&amp;&amp;page&lt;CONFIG.MAX_PAGES){const url=`${CONFIG.OPERATIONS_URL}?before=${encodeURIComponent(cursor)}&amp;per=${CONFIG.ITEMS_PER_PAGE}`;const response=await fetch(url,{headers:buildHeaders(jwt),});if (!response.ok){throw new Error(`Operations error:${response.status}${response.statusText}`);}const data=await response.json();if (data.items&amp;&amp;data.items.length&gt;0){allItems.push(...data.items);}hasMore=data.has_more===true;cursor=data.next_cursor;page++;onProgress(page,allItems.length);if (hasMore){await new Promise((resolve)=&gt;setTimeout(resolve,100));}}return {items_count:allItems.length,has_more:false,next_cursor:null,items:allItems,};}function crc32(data){if (!crc32.table){crc32.table=new Uint32Array(256);for (let i=0;i&lt;256;i++){let c=i;for (let j=0;j&lt;8;j++){c=c&amp;1?0xedb88320^(c&gt;&gt;&gt;1):c&gt;&gt;&gt;1;}crc32.table[i]=c;}}let crc=0xffffffff;for (let i=0;i&lt;data.length;i++){crc=crc32.table[(crc^data[i])&amp;0xff]^(crc&gt;&gt;&gt;8);}return (crc^0xffffffff)&gt;&gt;&gt;0;}function buildZip(entries){const localParts=[];const centralParts=[];let offset=0;for (const entry of entries){const nameBytes=new TextEncoder().encode(entry.name);const crc=crc32(entry.data);const local=new ArrayBuffer(30+nameBytes.length);const lv=new DataView(local);lv.setUint32(0,0x04034b50,true);lv.setUint16(4,20,true);lv.setUint16(6,0,true);lv.setUint16(8,0,true);lv.setUint16(10,0,true);lv.setUint16(12,0,true);lv.setUint32(14,crc,true);lv.setUint32(18,entry.data.length,true);lv.setUint32(22,entry.data.length,true);lv.setUint16(26,nameBytes.length,true);lv.setUint16(28,0,true);new Uint8Array(local).set(nameBytes,30);localParts.push(new Uint8Array(local),entry.data);const localSize=local.byteLength+entry.data.length;const central=new ArrayBuffer(46+nameBytes.length);const cv=new DataView(central);cv.setUint32(0,0x02014b50,true);cv.setUint16(4,20,true);cv.setUint16(6,20,true);cv.setUint16(8,0,true);cv.setUint16(10,0,true);cv.setUint16(12,0,true);cv.setUint16(14,0,true);cv.setUint32(16,crc,true);cv.setUint32(20,entry.data.length,true);cv.setUint32(24,entry.data.length,true);cv.setUint16(28,nameBytes.length,true);cv.setUint16(30,0,true);cv.setUint16(32,0,true);cv.setUint16(34,0,true);cv.setUint16(36,0,true);cv.setUint32(38,0,true);cv.setUint32(42,offset,true);new Uint8Array(central).set(nameBytes,46);centralParts.push(new Uint8Array(central));offset+=localSize;}const centralOffset=offset;let centralSize=0;for (const part of centralParts){centralSize+=part.length;}const eocd=new ArrayBuffer(22);const ev=new DataView(eocd);ev.setUint32(0,0x06054b50,true);ev.setUint16(4,0,true);ev.setUint16(6,0,true);ev.setUint16(8,entries.length,true);ev.setUint16(10,entries.length,true);ev.setUint32(12,centralSize,true);ev.setUint32(16,centralOffset,true);ev.setUint16(20,0,true);return new Blob([...localParts,...centralParts,new Uint8Array(eocd)],{type:&#x27;application/zip&#x27;,});}function downloadBlob(blob,filename){const url=URL.createObjectURL(blob);const a=document.createElement(&#x27;a&#x27;);a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}function showNotification(message){const existing=document.getElementById(&#x27;swile-export-notification&#x27;);if (existing){existing.remove();}const notification=document.createElement(&#x27;div&#x27;);notification.id=&#x27;swile-export-notification&#x27;;notification.style.cssText=`position:fixed;top:20px;right:20px;padding:16px 24px;background:#1a1a2e;color:white;border-radius:8px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;font-size:14px;z-index:999999;box-shadow:0 4px 12px rgba(0,0,0,0.3);`;notification.textContent=message;document.body.appendChild(notification);}function hideNotification(){const notification=document.getElementById(&#x27;swile-export-notification&#x27;);if (notification){notification.remove();}}try{if (!window.location.hostname.includes(&#x27;swile.co&#x27;)){alert(&#x27;This script must be run from team.swile.co&#x27;);return ;}const jwt=getJWT();if (!jwt){alert(&#x27;Swile session not found.\n\nMake sure you are logged in to team.swile.co&#x27;);return ;}showNotification(&#x27;Swile export in progress...&#x27;);showNotification(&#x27;Fetching wallets...&#x27;);const wallets=await fetchWallets(jwt);const operations=await fetchAllOperations(jwt,(page,total)=&gt;{showNotification(`Fetching operations...(page ${page},${total}operations)`);});showNotification(`Bundling ${operations.items_count}operations into zip...`);const encoder=new TextEncoder();const zip=buildZip([{name:&#x27;operations.json&#x27;,data:encoder.encode(JSON.stringify(operations,null,2))},{name:&#x27;wallets.json&#x27;,data:encoder.encode(JSON.stringify(wallets,null,2))},]);const today=new Date().toISOString().slice(0,10);downloadBlob(zip,`swile-export-${today}.zip`);setTimeout(()=&gt;{hideNotification();alert(`Swile export complete!\n\n${operations.items_count}operations exported.\n\nDownloaded:swile-export-${today}.zip`,);},1000);}catch (error){hideNotification();console.error(&#x27;Swile export error:&#x27;,error);alert(`Swile export error:\n\n${error.message}\n\nCheck the console for more details.`);}})();'
      >Swile Export</a
    >

    <p>
      <small>(Si tu ne vois pas ta barre de favoris : <code>Ctrl+Shift+B</code>)</small>
    </p>

    <h2>Utilisation</h2>

    <div class="step">
      <span class="step-number">1</span>
      Connecte-toi sur <a href="https://team.swile.co" target="_blank">team.swile.co</a>
    </div>

    <div class="step">
      <span class="step-number">2</span>
      Clique sur le bookmarklet "Swile Export" dans ta barre de favoris
    </div>

    <div class="step">
      <span class="step-number">3</span>
      Attends la fin de l'export (notification en haut a droite)
    </div>

    <div class="step">
      <span class="step-number">4</span>
      Un fichier <code>swile-export-YYYY-MM-DD.zip</code> est telecharge
    </div>

    <h2>Import dans budget-forecaster</h2>
    <p>Deplace le fichier zip dans ton dossier d'import puis :</p>
    <pre><code>python -m budget_forecaster.main -c config.yaml load swile-export-2025-01-15.zip</code></pre>
  </body>
</html>
